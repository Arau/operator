name: Publish develop image

on:
  push:
    branches:
      - main

env:
  MANIFEST_LIST: storageos/operator:develop
  AMD_IMAGE: storageos/operator:develop-amd64
  ARM64_IMAGE: storageos/operator:develop-arm64
  ARM_IMAGE: storageos/operator:develop-arm
  MANIFESTS_IMAGE: storageos/operator-manifests:develop

jobs:
  publish-image:
    runs-on: ubuntu-latest
    name: Publish container image
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          buildkitd-flags: "--debug"
      - name: Login to container registry
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: ${{ secrets.DH_USERNAME }}
          password: ${{ secrets.DH_PASSWORD }}
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v1
        with:
          version: latest
          args: --snapshot --rm-dist --config .github/.goreleaser-develop.yaml --skip-validate
      - name: Push container image
        run: |
          docker push ${{ env.AMD_IMAGE }}
          docker push ${{ env.ARM64_IMAGE }}
          docker push ${{ env.ARM_IMAGE }}
      - name: Create and publish manifest list
        run: |
          docker manifest create ${{ env.MANIFEST_LIST }} \
            ${{ env.AMD_IMAGE }} ${{ env.ARM64_IMAGE }} ${{ env.ARM_IMAGE }}
          docker manifest push ${{ env.MANIFEST_LIST }}
  publish-manifests-image:
    runs-on: ubuntu-latest
    name: Publish manifests container image
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16.x
      - name: Login to container registry
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: ${{ secrets.DH_USERNAME }}
          password: ${{ secrets.DH_PASSWORD }}
      - name: Run manifests image build
        run: OPERATOR_IMAGE=${{ env.MANIFEST_LIST }} make manifests-image
      - name: Push manifests container image
        run: docker push ${{ env.MANIFESTS_IMAGE }}
